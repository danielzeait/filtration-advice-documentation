<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>howk documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">howk documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  DialogData</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/modules/cases/new-case/new-case.component.ts</code>
        </p>







    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnInit, ViewChild, ChangeDetectorRef, QueryList } from &#x27;@angular/core&#x27;;
import { CaseProvider } from &#x27;src/app/providers/case.service&#x27;;
import { SupplierUnitsProvider } from &#x27;src/app/providers/supplier-units.provider&#x27;;
import { MatDialog } from &#x27;@angular/material/dialog&#x27;;
import { NavigationProvider } from &#x27;src/app/providers/navigation.provider&#x27;;
import { ActivatedRoute } from &#x27;@angular/router&#x27;;
import { ReplaceCostDialogComponent } from &#x27;src/app/components/modal-dialogs/replace-cost-dialog/replace-cost-dialog.component&#x27;;
import { AirFlowDialogComponent } from &#x27;src/app/components/modal-dialogs/airflow-dialog/air-flow-dialog.component&#x27;;
import { UtilsFunctions } from &#x27;src/app/providers/utils.functions&#x27;;
import { FilterTestReportsComponent } from &#x27;src/app/modules/reports/filter-test-reports/filter-test-reports.component&#x27;;
import { System } from &#x27;src/app/models/system.model&#x27;;
import { NotificationService } from &#x27;src/app/providers/notifications.service&#x27;;
import { HostListener } from &#x27;@angular/core&#x27;;
import { Observable } from &#x27;rxjs/Observable&#x27;;
import { LeaveDialogComponent } from &#x27;src/app/components/modal-dialogs/leave-dialog/leave-dialog.component&#x27;;
import { CustomErrorHandler } from &#x27;src/app/providers/error.service&#x27;;
import { CaseFormProvider } from &#x27;src/app/forms/new-case.form&#x27;;
import { MatStepper } from &#x27;@angular/material/stepper&#x27;
import { FormGroup } from &#x27;@angular/forms&#x27;;
import { PairedCaseInstrumentComponent } from &#x27;src/app/components/modal-dialogs/paired-case-instrument/paired-case-instrument.component&#x27;;
import { PairedCaseInstrumentProvider } from &#x27;src/app/providers/paired-case-instrument.service&#x27;;
import { LoaderProvider } from &#x27;src/app/providers/loader.service&#x27;;
import { CommonProvider } from &#x27;src/app/providers/common.service&#x27;;
import { PaymentProvider } from &#x27;src/app/providers/payment.service&#x27;;
import { MetaDataProvider } from &#x27;src/app/providers/metadata.service&#x27;;

export interface DialogData { }

@Component({
  selector: &#x27;app-new-case&#x27;,
  templateUrl: &#x27;./new-case.component.html&#x27;,
  styleUrls: [&#x27;./new-case.component.scss&#x27;]
})

export class NewCaseComponent implements OnInit {
  @ViewChild(FilterTestReportsComponent, { static: true }) standard: FilterTestReportsComponent;
  @ViewChild(&#x27;systemForm&#x27;, { static: true }) systemForm;
  @ViewChild(&#x27;stepper&#x27; , {static:true}) stepper: MatStepper;
  thirdFormGroup: FormGroup;
  standard_name: any;
  filter_for_case: any;
  system_costs: any;
  system_info: any;
  instrument_data: any;
  personal_data: any;
  user_profile:any;
  invalid_step: any &#x3D; [
    false,true,false,false,true,true,false,
  ];
  plans: any;
  case_in_memory: boolean;
  hole_new_case: boolean;
  can_continue: boolean;
  show_monitor_step: boolean &#x3D; true;
  @HostListener(&#x27;window:beforeunload&#x27;)
  canDeactivate(): Observable&lt;boolean&gt; | boolean {
    return false
  }
  
  public airflow_variable_values: any &#x3D; [];
  public attempt_to_change_filter: boolean;
  public case_to_edit: any;
  public days: any &#x3D; Array.from(Array(30), (x, index) &#x3D;&gt; index + 1);
  public dp_max: number;
  public dp_min: number;
  public displayedColumns: string[] &#x3D; [&#x27;number&#x27;, &#x27;created&#x27;, &#x27;laboratory&#x27;, &#x27;efficiency&#x27;, &#x27;owner&#x27;];
  public discard_leaving_alert: boolean;
  public efficienciesError &#x3D; [false, false, false];
  public filter: any;
  public hours: any &#x3D; Array.from(Array(24), (x, index) &#x3D;&gt; index + 1);
  public is_edit: any;
  public months: any &#x3D; Array.from(Array(12), (x, index) &#x3D;&gt; index + 1);
  public no_filter_selected &#x3D; false;
  public report: any &#x3D; [];
  public system: any &#x3D; null;
  public case_instruments:any;
  public units: any;
  public system_error:any&#x3D;false;
  public step:any&#x3D;1;

  constructor(
    private caseProvider: CaseProvider,
    public dialog: MatDialog,
    public utils: UtilsFunctions,
    private loaderService:LoaderProvider,
    public paymentProvider:PaymentProvider,
    private cdr: ChangeDetectorRef,
    private pairCaseInstrumentProvider:PairedCaseInstrumentProvider,
    public notificationProvider: NotificationService,
    public commonProvider:CommonProvider,
    private unitsProvider: SupplierUnitsProvider,
    private activatedRoute: ActivatedRoute,
    private handlerError: CustomErrorHandler,
    private metadata:MetaDataProvider,
    private formsProvider:CaseFormProvider,
    private navigator: NavigationProvider) {
  }

  ngOnInit() {
    localStorage.removeItem(&#x27;provider_selected&#x27;);
    //check params if filer is comming
    this.checkStateParams();

    // Check if the view is new case or edit
    this.checkEditOrNewCase();

    this.systemForm &#x3D; this.formsProvider.caseForm();
    if(this.case_to_edit){
      this.systemForm.controls.drive_efficiency.value &#x3D; this.system.drive_efficiency;
      this.systemForm.controls.fan_efficiency.value &#x3D; this.system.fan_efficiency;
      this.systemForm.controls.motor_efficiency.value &#x3D; this.system.motor_efficiency;
      this.systemForm.controls.has_resport.value &#x3D; true;
    }else{
      if(this.report){
        this.systemForm.controls.has_resport.value &#x3D; true;
      }
    }

    this.paymentProvider.getAllProducts().subscribe((response)&#x3D;&gt;{
      this.plans &#x3D; {
        new_optimization:response.find(plan &#x3D;&gt; plan.slug &#x3D;&#x3D; &quot;optimization&quot;),
        edit_optimization:response.find(plan &#x3D;&gt; plan.slug &#x3D;&#x3D; &quot;optimization_update&quot;),
      };
    },error&#x3D;&gt;{
      this.handlerError.handleError(error);
    })
  }

  ngAfterViewChecked() {
    this.cdr.detectChanges();
  }
  
  ngAfterViewInit() {    
    if(this.case_to_edit &amp;&amp; !this.case_to_edit.monitoring_module){
      this.show_monitor_step &#x3D; false;
    }
  }

  ngOnDestroy() {
    if (!this.attempt_to_change_filter) {
      localStorage.removeItem(&#x27;max_airflow_allowed&#x27;);
    }
    if(!this.can_continue){
      localStorage.removeItem(&#x27;new_case_data&#x27;);
      localStorage.removeItem(&#x27;filter_for_case&#x27;);
      localStorage.removeItem(&#x27;reports_for_case&#x27;);
      localStorage.removeItem(&#x27;max_airflow_allowed&#x27;);
      this.cancelCase();
    }
    //localStorage.removeItem(&#x27;filter_for_case&#x27;);
    //localStorage.removeItem(&#x27;report_for_case&#x27;);
    //localStorage.removeItem(&#x27;case_to_edit&#x27;);
  }

  /******************************************************************
  *                                                                 *
  *     CHECKING STATE OF PAGE RATHER IS A NEW CASE OR EDIT ONE     *
  *                                                                 *
  *******************************************************************/

  checkStateParams() {
    this.activatedRoute.queryParams.subscribe(async params &#x3D;&gt; {
      if (localStorage.getItem(&#x27;filter_for_case&#x27;)) {
        this.filter &#x3D; JSON.parse(localStorage.getItem(&#x27;filter_for_case&#x27;));
        this.filter_for_case &#x3D; JSON.parse(localStorage.getItem(&#x27;filter_for_case&#x27;));
        this.no_filter_selected &#x3D; false;
        //this.stepper.selectedIndex &#x3D; 2;
      }

      if (params.study_case &amp;&amp; params.study_case !&#x3D;&#x3D; &#x27;null&#x27;) {
        this.case_to_edit &#x3D; JSON.parse(params.study_case);
      }
      if (params.edit_case &#x3D;&#x3D; &#x27;true&#x27;) {
        this.case_to_edit &#x3D; JSON.parse(localStorage.getItem(&#x27;case_to_edit&#x27;));
        localStorage.removeItem(&#x27;case_to_edit&#x27;);
      }
    });

  }

  checkEditOrNewCase() {
    if (this.case_to_edit !&#x3D; null) {
      // CASE IS BEING EDITTING
      this.setEditValues();
      this.getDpLimits();
    } else {
      // CHECK IF A CASE ALREADY EXIST IN MEMORY
      let case_data &#x3D; localStorage.getItem(&#x27;new_case_data&#x27;);
      if (case_data) {
        let type_of_consumer &#x3D; JSON.parse(case_data).type_of_consumer
        this.user_profile &#x3D; this.metadata.filterProfiles(type_of_consumer);
        this.system &#x3D; new System(JSON.parse(case_data));
        this.setMemoryValues();
        //this.airflow_variable_values &#x3D; this.system.airflows_per_filter;
        //this.setEditValues();
      } else {

        // HOLE NEW CASE
        this.hole_new_case &#x3D; true;
        this.system &#x3D; new System();
        this.airflow_variable_values &#x3D; [
          { flow: parseFloat(&#x27;118&#x27;).toFixed(2), percent: 0 },
          { flow: parseFloat(&#x27;118&#x27;).toFixed(2), percent: 0 },
          { flow: parseFloat(&#x27;118&#x27;).toFixed(2), percent: 0 },
          { flow: parseFloat(&#x27;118&#x27;).toFixed(2), percent: 0 },
        ];
        this.initExtraCosts();
      }

      this.system.current_model_filter &#x3D; this.filter;
      if (this.system.current_model_filter) {
        this.system.setSystemSizes(this.system);
      }

      //CHECK FOR REPORTS IN MEMEORY 
      let report_selected &#x3D; JSON.parse(localStorage.getItem(&#x27;report_for_case&#x27;));
      if (report_selected &amp;&amp; report_selected.length &#x3D;&#x3D; 0) {
        this.report &#x3D; this.filter.reports.public;
      } else {
        this.report &#x3D; report_selected;
      }

      //SET NORM 
      let norm &#x3D; this.activatedRoute.snapshot.queryParams.norm;
      if (norm) {
        this.system.standard &#x3D; norm;
        this.standard_name &#x3D; this.activatedRoute.snapshot.queryParams.standard_name;
      }

      if (this.report) {
        this.system.current_filter.private_report_ids &#x3D; [];
        this.report.map(report &#x3D;&gt; !report.is_public ? this.system.current_filter.private_report_ids.push(report.id) : report);
        setTimeout(() &#x3D;&gt; {
          this.getDpLimits();
        }, 1500);
      }

      this._updateHoursOfUse();
      this._updateTotalAirflow();
    }
    this.unitsProvider.getUnitsActive().then(metrics &#x3D;&gt; {
      this.units &#x3D; metrics;
    });
  }

  setMemoryValues(){
    //this.is_edit &#x3D; true;
    //this.case_to_edit &#x3D; true;
    this.system_costs&#x3D;{
      filter_extra_cost:this.system.current_filter.filter_extra_cost,
      freight_cost:this.system.current_filter.filter_extra_cost[0].value,
      labor_cost:this.system.current_filter.filter_extra_cost[1].value,
      disposal_cost:this.system.current_filter.filter_extra_cost[2].value,
      filter_cost:this.system.current_filter.filter_cost,
      energy_cost:this.system.energy_cost,
      carbon_footprint:this.system.carbon_footprint,
      filters_number:this.system.filters_number,
    };
    this.personal_data &#x3D; {...this.system};
    this.personal_data.job_information &#x3D; this.system.case_data.job_information;
    this.personal_data.personal_zip_code &#x3D; this.system.case_data.personal_zip_code;
    this.personal_data.industry_type &#x3D; this.system.client_type_of_consumer;
    this.personal_data.system_location &#x3D; this.system.system_location;
    delete this.personal_data.drive_efficiency;
    delete this.personal_data.motor_efficiency;
    delete this.personal_data.fan_efficiency;
    delete this.personal_data.months_per_year;
    delete this.personal_data.days_per_month;
    delete this.personal_data.hours_per_day;
    delete this.personal_data.hours_per_year;
    delete this.personal_data.replacement_cycle;
    delete this.personal_data.airflow_per_filter;
    delete this.personal_data.total_airflow;
    delete this.personal_data.average_pressure_drop;
    delete this.personal_data.installation_date;
    delete this.personal_data.variable_airflow;
    delete this.personal_data.maximum_operational_dp;

    this.system_info &#x3D; {...this.system};
    delete this.system_info.energy_cost;
    delete this.system_info.carbon_footprint;
    this.system_info.airflow_per_filter &#x3D; this.system.total_airflow / this.system.filters_number;
    this.system_info.average_pressure_drop &#x3D;  this.system.case_data.average_pressure_drop;
    this.system_info.installation_date &#x3D; this.system.case_data.installation_date;
    this.system.airflows_per_filter &#x3D; this.system.airflows_per_filter;
    this.system_info.airflows_per_filter &#x3D; this.system.airflows_per_filter;
    this.system_info.airflows_per_filter.map(airflow &#x3D;&gt; airflow.flow *&#x3D; this.system.filters_number);
    this.system.variable_airflow ? this.system_info.variable_airflow &#x3D; 2 : this.system_info.variable_airflow &#x3D; 1;
    this.system.current_filter.is_already_updated &#x3D; this.system.case_data.current_filter.is_already_updated;

    
    if(localStorage.getItem(&#x27;reports_for_case&#x27;)){
      this.system.reports &#x3D; JSON.parse(localStorage.getItem(&#x27;reports_for_case&#x27;));
    }

    if (this.system.current_filter.filter_extra_cost.length &gt; 0) {
      this.retrieveExtraCosts();
    } else {
      this.initExtraCosts();
    }
    
    if(this.system.monitoring_module){
      this.instrument_data &#x3D; this.system.monitoring_module;
      this.caseProvider.getCaseInstruments(this.system.alter_autoincrement_id).subscribe(
        (case_instruments)&#x3D;&gt;{
          this.case_instruments &#x3D; case_instruments;
        }
      )
    }else{
      this.show_monitor_step &#x3D; false;
    }
    this.no_filter_selected &#x3D; false;
    this.step &#x3D; 4;
    this.case_in_memory &#x3D; true;
    //localStorage.setItem(&#x27;case_in_memory&#x27;,&#x27;true&#x27;);
  }

  setEditValues() {
    this.is_edit &#x3D; true;
    localStorage.setItem(&#x27;case_in_edition&#x27;,&#x27;true&#x27;);
    this.no_filter_selected &#x3D; false;
    this.filter &#x3D; this.case_to_edit.current_filter.model_filter;
    this.system &#x3D; new System(this.case_to_edit);
    this.system.current_model_filter &#x3D; this.case_to_edit.current_filter.model_filter;
    this.system.cost_per_filter &#x3D; this.case_to_edit.current_filter.filter_cost;
    this.system.is_already_updated &#x3D; this.case_to_edit.current_filter.is_already_updated;
    this.system.avg_dp_filter_change &#x3D; this.case_to_edit.average_pressure_drop;
    this.system.variable_airflow ? this.system.variable_airflow &#x3D; 2 : this.system.variable_airflow &#x3D; 1;
    this.airflow_variable_values &#x3D; this.system.airflows_per_filter;
    this.system.zip_code &#x3D; this.case_to_edit.company_zip_code;
    this.system.calculateAverageAirflow(this.system, this.airflow_variable_values);
    this.report &#x3D; this.system.current_filter.reports;
    this.filter_for_case &#x3D; this.case_to_edit.current_filter.model_filter;
    this.filter_for_case.case_size_width &#x3D; this.case_to_edit.width;
    this.filter_for_case.case_size_height &#x3D; this.case_to_edit.height;
    
    this.system_costs&#x3D;{
      filter_extra_cost:this.case_to_edit.current_filter.filter_extra_cost,
      freight_cost:this.case_to_edit.current_filter.filter_extra_cost[0].value,
      labor_cost:this.case_to_edit.current_filter.filter_extra_cost[1].value,
      disposal_cost:this.case_to_edit.current_filter.filter_extra_cost[2].value,
      filter_cost:this.case_to_edit.current_filter.filter_cost,
      energy_cost:this.case_to_edit.energy_cost,
      carbon_footprint:this.case_to_edit.carbon_footprint,
      filters_number:this.case_to_edit.filters_number,
    };

    this.personal_data &#x3D; {...this.case_to_edit};
    delete this.personal_data.drive_efficiency;
    delete this.personal_data.motor_efficiency;
    delete this.personal_data.fan_efficiency;
    delete this.personal_data.months_per_year;
    delete this.personal_data.days_per_month;
    delete this.personal_data.hours_per_day;
    delete this.personal_data.hours_per_year;
    delete this.personal_data.replacement_cycle;
    delete this.personal_data.airflow_per_filter;
    delete this.personal_data.total_airflow;
    delete this.personal_data.average_pressure_drop;
    delete this.personal_data.installation_date;
    delete this.personal_data.variable_airflow;
    delete this.personal_data.maximum_operational_dp;

    this.system_info &#x3D; {...this.case_to_edit};
    delete this.system_info.energy_cost;
    delete this.system_info.carbon_footprint;
    this.system_info.airflow_per_filter &#x3D; this.case_to_edit.total_airflow / this.case_to_edit.filters_number;
    this.system_info.average_pressure_drop &#x3D;  this.case_to_edit.average_pressure_drop;
    this.system.airflows_per_filter &#x3D; this.case_to_edit.airflows_per_filter;
    this.system_info.airflows_per_filter &#x3D; this.case_to_edit.airflows_per_filter;
    this.system_info.airflows_per_filter.map(airflow &#x3D;&gt; airflow.flow *&#x3D; this.case_to_edit.filters_number);
    this.case_to_edit.variable_airflow ? this.system_info.variable_airflow &#x3D; 2 : this.system_info.variable_airflow &#x3D; 1;
    this.system.reports &#x3D; this.case_to_edit.current_filter.reports;
    this.user_profile &#x3D; this.metadata.filterProfiles(this.case_to_edit.type_of_consumer);
    this.step &#x3D; 4;
    if (this.system.current_filter.reports[0].user) {
      this.system.current_filter.reports[0].user &#x3D; this.system.current_filter.reports[0].user;
    } else {
      this.system.current_filter.reports[0].user &#x3D; &#x27;PUBLIC&#x27;;
    }

    if (this.case_to_edit.current_filter.filter_extra_cost.length &gt; 0) {
      this.retrieveExtraCosts();
    } else {
      this.initExtraCosts();
    }
    if(this.case_to_edit.monitoring_module){
      this.instrument_data &#x3D; this.case_to_edit.monitoring_module;
      this.caseProvider.getCaseInstruments(this.case_to_edit.alter_autoincrement_id).subscribe(
        (case_instruments)&#x3D;&gt;{
          this.case_instruments &#x3D; case_instruments;
        }
      )
    }
  }

  // Given an array of costs separate them in annual and additional per cycle
  retrieveExtraCosts() {
    this.system.separateCosts(this.system);
  }

  // If a new case is on the go then extra costs must be set by default
  initExtraCosts() {
    this.system.initializeExtraCosts(this.system);
  }

  /******************************************************************
  *           END OF CHECKING AND INIT VALUES FOR CASE              *
  *******************************************************************/


  /******************************************************************
  *                                                                 *
  *        FORM OPERATIONS WHILE USER IS FILLING DATA               *
  *                                                                 *
  *******************************************************************/

  // Given zip code and type of industry calculate energy cost an CO2 emmison
  _calculateEnergyCosts() {
    // if (this.system.zip_code !&#x3D;&#x3D; &#x27;&#x27; &amp;&amp; this.system.industry_type) {
    //   this.caseProvider.getEnergyCosts(this.system).subscribe((response) &#x3D;&gt; {
    //     this.system.energy_cost &#x3D; response.energy_cost;
    //     this.system.carbon_footprint &#x3D; response.carbon_footprint;
    //   }, error &#x3D;&gt; {
    //     if (error.status &#x3D;&#x3D; 404) {
      //     }
      //   });
      // }
    // this.system.energy_cost ? this.system.energy_cost : this.system.energy_cost &#x3D; &#x27;&#x27;;
    // this.system.carbon_footprint ? this.system.carbon_footprint : this.system.carbon_footprint &#x3D; &#x27;&#x27;;
  }  

  _setStep(n:any){
    this.step &#x3D; n;
  }

  // Change the filter test report only when creating case
  _changeFilterTestReport() {
    localStorage.setItem(&#x27;new_case_data&#x27;, JSON.stringify(this.system));
    this.navigator._goFilterList();
    this.discard_leaving_alert &#x3D; true;
    this.attempt_to_change_filter &#x3D; true;
  }

  // Given a report and filter size and flow, min and max dep must be calculated
  getDpLimits() {
    if (this.report &amp;&amp; this.report.length &gt; 0 &amp;&amp; this.system.height &amp;&amp; this.system.width &amp;&amp; this.system.airflow_per_filter) {
      var data &#x3D; {
        &quot;height&quot;: this.system.height,
        &quot;width&quot;: this.system.width,
        &quot;reports&quot;: this.report.map(r &#x3D;&gt; r.id),
        &quot;airflows_per_filter&quot;: [{
          flow: this.system.airflow_per_filter,
          percent: 100
        }]
      }
      
    } else if (this.report &amp;&amp; this.report.length &gt; 0) {
      var data &#x3D; {
        &quot;height&quot;: this.system.current_model_filter.size_height,
        &quot;width&quot;: this.system.current_model_filter.size_width,
        &quot;reports&quot;: this.report.map(r &#x3D;&gt; r.id),
        &quot;airflows_per_filter&quot;: [{
          flow: this.system.maximum_airflow_allowed,
          percent: 100
        }]
      }
    }

    this.caseProvider.getSystemDpValues(data).subscribe(
      (dp_values) &#x3D;&gt; {
        this.dp_max &#x3D; parseFloat(dp_values.max_dp.toFixed(2));
        this.dp_min &#x3D; parseFloat(dp_values.min_dp_current.toFixed(2));
        this.systemForm.controls[&#x27;min_dp&#x27;].setValue(this.dp_min);
        this.systemForm.controls[&#x27;max_dp&#x27;].setValue(this.dp_max);
      }, error &#x3D;&gt; {})
    this._validateAirflowInput();
  }
  
  // Every time a number change fix input with decimals
  setAmountDecimal(ev) {
    this.utils.transformAmount(ev);
  }
  
  //Set efficiency for Drive
  _setDriverEfficiency(val) {
    this.system.setDriverEfficiency(this.system, val);
    this.systemForm.controls[&#x27;drive_efficiency&#x27;].setValue(val);
    val &#x3D;&#x3D; &#x27;&#x27; || val &#x3D;&#x3D; null || val &lt; 0 || val &gt; 100 ? this.efficienciesError[1] &#x3D; true : this.efficienciesError[1] &#x3D; false;
  }
  
  //Set efficiency for Motor
  _setMotorEfficiency(val) {
    this.system.setMotorEfficiency(this.system, val);
    this.systemForm.controls[&#x27;motor_efficiency&#x27;].setValue(val);
    val &#x3D;&#x3D; &#x27;&#x27; || val &#x3D;&#x3D; null || val &lt; 0 || val &gt; 100 ? this.efficienciesError[0] &#x3D; true : this.efficienciesError[0] &#x3D; false;
  }

  //Set efficiency for Fan
  _setFanEfficiency(val) {
    this.system.setFanEfficiency(this.system, val);
    this.systemForm.controls[&#x27;fan_efficiency&#x27;].setValue(val);
    val &#x3D;&#x3D; &#x27;&#x27; || val &#x3D;&#x3D; null || val &lt; 0 || val &gt; 100 ? this.efficienciesError[2] &#x3D; true : this.efficienciesError[2] &#x3D; false;
  }
  
  // Given a filter size airflow limit must be calculated
  updateAirflowLimit() {
    this.system.maximum_airflow_allowed &#x3D; this.system.calculateMaxAirflowAllowed(this.system);
    !this.is_edit ? this.system.airflow_per_filter &#x3D; this.system.maximum_airflow_allowed : this.system.airflow_per_filter;
  }

  /* Once the months days or hours change, new system operation hours 
  must be calculated */
  _updateHoursOfUse() {
    this.system.calculateHoursOfUse(this.system);
  }

  // Calculate total airflow of system
  _updateTotalAirflow() {
    this.system.calculateTotalAirflow(this.system);
  }

  // Given a system calculate total cost per set per cycle
  updateTotalCostsPerCycle() {
    this.system.calculateTotalCostsPerCycle(this.system);
  }

  // Check if input value of airflow is correct
  _validateAirflowInput(){
    if (this.system.airflow_per_filter &gt; this.system.maximum_airflow_allowed) {
      this.system.airflow_per_filter &#x3D; this.system.maximum_airflow_allowed;
    } else if (this.system.airflow_per_filter &lt; this.system.min_airflow_allowed) {
      this.system.airflow_per_filter &#x3D; this.system.min_airflow_allowed;
    }
  }
  
  /******************************************************************
  *                                                                 *
  *                     OPTIMIZATION PROCESS                        *
  *                                                                 *
  *******************************************************************/

  
  saveCase(){
    if(this.system.alter_autoincrement_id){
      let system_data &#x3D; this.prepareData();
      this._saveCase(true,false,system_data);
    }else{
      this.createCase();
    }
  }

  // Create a new case and complete navigation
  _createCase(optimize: boolean, compare: boolean, system_data?) {
    let data &#x3D; system_data ? system_data : this.system;
    data.current_filter.is_paid_with_credits &#x3D; false;
    this.can_continue &#x3D; true;
    this.discard_leaving_alert &#x3D; true;
    
    if(this.instrument_data){
      this.instrument_data.installation_date &#x3D; this.utils.formatDateISO(data.installation_date);
      data.monitoring_module &#x3D; this.instrument_data;
      this._createMonitoredCase(data);
    }else{
      this.plans.new_optimization.action &#x3D; &#x27;optimization&#x27;;
      localStorage.setItem(&#x27;pending_optimization&#x27;,JSON.stringify(data));
      localStorage.setItem(&#x27;new_case_data&#x27;,JSON.stringify(data));
      localStorage.setItem(&#x27;filter_for_case&#x27;,JSON.stringify(this.filter_for_case));
      localStorage.setItem(&#x27;reports_for_case&#x27;,JSON.stringify(this.system.reports));
      localStorage.setItem(&#x27;pending_instrumentation&#x27;,JSON.stringify(this.instrument_data));
      this.navigator._goCheckOut(this.plans.new_optimization);
    }
  }

  _createMonitoredCase(case_data){
    this.caseProvider.createNewCase(case_data,true).subscribe(
      (response) &#x3D;&gt; {
        this.commonProvider.showSnackBar(&#x27;New case created&#x27;,&#x27;Your new case has been created correctly&#x27;,&#x27;success-snackbar&#x27;);
        this.completeNavigationCaseDone(true,false,response);
      }, error &#x3D;&gt; {
        this.handlerError.handleError(error);
    });
  }

  // Save existing case and complete navigation
  _saveCase(optimize: boolean, compare: boolean, case_data?) {
    var _case:any; 
    case_data ? _case &#x3D; case_data : _case &#x3D; this.system;
    _case.current_filter.is_paid_with_credits &#x3D; false;
    if(_case.current_filter.is_already_updated){
      this.plans.edit_optimization.action &#x3D; &#x27;update-optimization&#x27;;
      localStorage.setItem(&#x27;pending_optimization&#x27;,JSON.stringify(_case));
      localStorage.setItem(&#x27;pending_instrumentation&#x27;,JSON.stringify(this.instrument_data));
      localStorage.setItem(&#x27;new_case_data&#x27;,JSON.stringify(_case));
      localStorage.setItem(&#x27;filter_for_case&#x27;,JSON.stringify(this.filter_for_case));
      localStorage.setItem(&#x27;reports_for_case&#x27;,JSON.stringify(this.system.reports));
      this.discard_leaving_alert &#x3D; true;
      this.can_continue &#x3D; true;
      this.navigator._goCheckOut(this.plans.edit_optimization);
    }else{
      this.discard_leaving_alert &#x3D; true;
      if(this.instrument_data &amp;&amp; this.instrument_data.drop_pressure_inst !&#x3D;&#x3D; null &amp;&amp; this.instrument_data.flow_inst !&#x3D;&#x3D; null){
        _case.monitoring_module &#x3D; this.instrument_data;
      }
      this.caseProvider.updateCase(_case).subscribe(
      (response) &#x3D;&gt; {
        this.commonProvider.showSnackBar(&#x27;Case updated&#x27;,&#x27;Your case has been saved correctly&#x27;,&#x27;success-snackbar&#x27;);
        this.completeNavigationCaseDone(optimize, compare, response);
      }, error &#x3D;&gt; {
        this.handlerError.handleError(error);
      });
    }
  }

  // Once the optimization is done might go to result, comparison or case list
  completeNavigationCaseDone(show_optimization, go_comparison, optimization_data) {
    if (show_optimization) {
      this.caseProvider.getCase(optimization_data.alter_autoincrement_id).subscribe((case_data) &#x3D;&gt; {
        this.navigator._goOptimizationsResults(case_data);
      })
    } else if (go_comparison) {
      this.caseProvider.getCase(optimization_data.alter_autoincrement_id).subscribe((case_data) &#x3D;&gt; {
        this.navigator._goNewComparisonCaseSelected(case_data);
      })
    } else {
      this.backToCaseList();
    }
  }

  pairInstruments(case_data){
    this.instrument_data.installation_date &#x3D; this.utils.formatDateISO(this.instrument_data.installation_date);
    this.pairCaseInstrumentProvider.createNewPaired(this.instrument_data,case_data.alter_autoincrement_id).subscribe((response)&#x3D;&gt;{
      this.completeNavigationCaseDone(true, false, case_data);
      this.commonProvider.showSnackBar(&#x27;Paired.&#x27;,&#x27;The instrument was paired with your case correctly.&#x27; ,&#x27;success-snackbar&#x27;);
    },error&#x3D;&gt;{
      this.handlerError.handleError(error);
    })
  }

  /******************************************************************
  *            END OF CASE CREATION OR OPTIMIZATION                 *
  *******************************************************************/


  /******************************************************************
  *                                                                 *
  *            MODALS IN NEW CASE AND OPTIMIZATION                  *
  *                                                                 *
  *******************************************************************/


  // Modal for AIRFLOW

  _openModalAirflow(): void {
    if (this.system.variable_airflow &#x3D;&#x3D; &#x27;2&#x27;) {
      const data &#x3D; {
        airflows: this.airflow_variable_values,
        airflow_limit: this.system.maximum_airflow_allowed
      };
      const dialogRef &#x3D; this.dialog.open(AirFlowDialogComponent, {
        width: &#x27;50%&#x27;,
        height: &#x27;75%&#x27;,
        data,
        id: &#x27;airflow&#x27;
      });

      dialogRef.afterClosed().subscribe(result &#x3D;&gt; {
        this.airflow_variable_values &#x3D; this.airflow_variable_values;
        this.system.airflows_per_filter &#x3D; data.airflows;
        if (result) {
          this.system.airflow_per_filter &#x3D; result.average;
          this._updateTotalAirflow();
        }
      });
    }
  }

  // Modal for COST PER CYCLE
  addMoreCostPerCycle() {
    let costs_data &#x3D; {
      costs: this.system.additional_costs,
      type: &#x27;cycle&#x27;
    };
    const dialogRef &#x3D; this.dialog.open(ReplaceCostDialogComponent, {
      width: &#x27;50%&#x27;,
      height: &#x27;70%&#x27;,
      data: costs_data
    });
    dialogRef.afterClosed().subscribe(result &#x3D;&gt; {
      if (result) {
        this.system.updateCostPerCycle(this.system, result);
      }
    });
  }

  // Modal for ANNUAL COST
  addAnnualCosts() {
    let costs_data &#x3D; {
      costs: this.system.annual_cost,
      type: &#x27;annual&#x27;
    };
    const dialogRef &#x3D; this.dialog.open(ReplaceCostDialogComponent, {
      width: &#x27;50%&#x27;,
      height: &#x27;70%&#x27;,
      data: costs_data
    });
    dialogRef.afterClosed().subscribe(result &#x3D;&gt; {
      if (result) {
        this.system.updateAnnualCosts(this.system, result);
      }
    });
  }

  // CANCEL EDITING OR NEW CASE
  cancelCase() {
    this.canExit().then((can_leave)&#x3D;&gt;{
      if(can_leave){
        this.backToCaseList();
      }
    })
  }
  
  backToCaseList() {
    localStorage.removeItem(&#x27;new_case_data&#x27;);
    localStorage.removeItem(&#x27;filter_for_case&#x27;);
    localStorage.removeItem(&#x27;reports_for_case&#x27;);
    localStorage.removeItem(&#x27;max_airflow_allowed&#x27;);
    this.navigator._goHomeCasesClear();
  }

  async canExit(): Promise&lt;boolean&gt; {

    var leave &#x3D; false;

    if (!this.discard_leaving_alert) {

      const dialogRef &#x3D; this.dialog.open(LeaveDialogComponent, {
        width: &#x27;50%&#x27;,
        height: &#x27;30%&#x27;,
      });

      leave &#x3D; await dialogRef.afterClosed().toPromise();
      return leave
    } else {
      return true
    }
  }

  // WINDOW SCROLL
  scrollToTop(el) {
    const scrollToTop &#x3D; window.setInterval(() &#x3D;&gt; {
      const pos &#x3D; window.pageYOffset;
      if (pos &gt; 50) {
        window.scrollTo(el, pos - 20); // how far to scroll on each step
      } else {
        this.no_filter_selected &#x3D; true;
        window.clearInterval(scrollToTop);
      }
    }, 16);
  }

  public onStepChange(event): void{}

  continue(stepper?: MatStepper){
    stepper.next();
  }

  setCaseFilter(filter){
    this.filter_for_case &#x3D; {...filter};
  }

  setProfile(profile){
    this.user_profile &#x3D; {...profile};
    if(!this.user_profile.is_monitored){
      this.show_monitor_step &#x3D; false;
    }else{
      this.show_monitor_step &#x3D; true;
    }
  }
  
  setPersonalData(personal_data){
    this.personal_data &#x3D; {...personal_data};
    this.system.name &#x3D; this.personal_data.case_name;
    if(!this.system.name || this.system.name &#x3D;&#x3D; &quot;&quot;){
      this.invalid_step[1] &#x3D; true;
    }else{
      this.invalid_step[1] &#x3D; false;
    }
  }
  
  retrieveCosts(costs_data){
    this.system.filters_number &#x3D; costs_data.filters_number;
    this.system_costs &#x3D; {...costs_data};
    if(
        !this.system_costs.filters_number || this.system_costs.filters_number &#x3D;&#x3D; &#x27;&#x27; ||
        !this.system_costs.filter_cost || this.system_costs.filter_cost &#x3D;&#x3D; &#x27;&#x27; || 
        !this.system_costs.energy_cost || this.system_costs.energy_cost &#x3D;&#x3D; &#x27;&#x27; ||
        !this.system_costs.carbon_footprint || this.system_costs.carbon_footprint &#x3D;&#x3D; &#x27;&#x27; ){
        this.invalid_step[4] &#x3D; true;
    }else{
      this.invalid_step[4] &#x3D; false
    }
  }
  
  setSystemInformation(data){
    this.system_info &#x3D; {...data};
    if(
      !this.instrument_data &amp;&amp; 
      (!this.system_info.average_pressure_drop || this.system_info.average_pressure_drop &#x3D;&#x3D; &#x27;&#x27; ||
      !this.system_info.replacement_cycle || this.system_info.replacement_cycle &#x3D;&#x3D; &#x27;&#x27; || 
      !this.system_info.airflow_per_filter || this.system_info.airflow_per_filter &#x3D;&#x3D; &#x27;&#x27;)){
      this.invalid_step[5] &#x3D; true;
    }else{
      this.invalid_step[5] &#x3D; false
    }
  }

  setRportsForCase(reports){
    this.system.reports &#x3D; [...reports];
    // this.caseProvider.getDpValues(this.system.reports[0]).subscribe((values)&#x3D;&gt;{
    //   console.log(values);
    // })
  }
  
  setInstrumentData(instrument_data){
    this.instrument_data &#x3D; {...instrument_data.data};
    this.case_instruments &#x3D; {
      flow_inst:{...instrument_data.instruments[0]},
      drop_pressure_inst:{...instrument_data.instruments[1]} 
    }
  }

  setSystemError(event){
    //this.system_error &#x3D; event ? true : false;
  }

  move(index: number) {
    this.stepper.selectedIndex &#x3D; index;
    let steps:QueryList&lt;any&gt;;
    steps &#x3D; this.stepper._steps;
  }

  changeStep(step){
    window.scrollTo({
      top: 0,
      behavior: &#x27;smooth&#x27;,
    })
    setTimeout(() &#x3D;&gt; {
      this.step &#x3D; step;
    }, 500);
  }

  createCase(){
    let system_data &#x3D; this.prepareData();
    this._createCase(true,false, system_data);
  }
  
  prepareData(){
    let case_data &#x3D; {...this.system_costs, ...this.system_info, ...this.personal_data}
    case_data.backward_fan &#x3D; false;
    case_data.is_draft &#x3D; false;
    case_data.forward_fan &#x3D; false;
    case_data.radial_fan &#x3D; false;
    case_data.name &#x3D; this.system.name;
    case_data.client_type_of_consumer &#x3D; this.personal_data.industry_type;
    case_data.industry_type &#x3D; this.personal_data.industry_type.id;
    case_data.height &#x3D; this.filter_for_case.case_size_height;
    case_data.length &#x3D; this.filter_for_case.case_size_depth;
    case_data.width &#x3D; this.filter_for_case.case_size_width;
    case_data.variable_airflow &#x3D; this.system_info.variable_airflow &#x3D;&#x3D; 1 ? false : true;
    case_data.average_pressure_drop &#x3D; this.system_info.average_pressure_drop;
    case_data.current_filter &#x3D; {};
    case_data.current_filter.filter_extra_cost &#x3D; this.system_costs.filter_extra_cost;
    case_data.current_filter.model_filter &#x3D; this.filter_for_case.id;
    case_data.current_filter.filter_cost &#x3D; this.system_costs.filter_cost;
    case_data.current_filter.name &#x3D; this.filter_for_case.name;
    case_data.current_filter.is_already_updated &#x3D; this.system.current_filter.is_already_updated;
    case_data.current_filter.filter_image &#x3D; this.filter_for_case.picture;
    case_data.standard &#x3D; this.system.reports[0].standard.id;
    case_data.carbon_footprint &#x3D; this.system_costs.carbon_footprint;
    case_data.energy_cost &#x3D; this.system_costs.energy_cost;
    case_data.filters_number &#x3D; this.system_costs.filters_number;
    case_data.type_of_consumer &#x3D; this.user_profile.type;
    
    if(!this.system.reports[0].is_public){
      case_data.current_filter.private_report_ids &#x3D; [];
      this.system.reports.forEach(element &#x3D;&gt; {
        case_data.current_filter.private_report_ids.push(element.id); 
      });
    }
  
    if(!case_data.variable_airflow){
      case_data.airflows_per_filter &#x3D; [
        {&#x27;flow&#x27;:this.system_info.airflow_per_filter,&#x27;percent&#x27;:100}
      ]
    }else{
      case_data.airflows_per_filter &#x3D; [];
      this.system_info.airflows_per_filter.forEach(value &#x3D;&gt; case_data.airflows_per_filter.push(
        {
          &#x27;flow&#x27;:value.flow / case_data.filters_number,
          &#x27;percent&#x27;:value.percent,
        }
      ));
    }

    if(this.instrument_data){
      case_data.average_pressure_drop &#x3D; null;
      case_data.airflows_per_filter &#x3D; null;
      case_data.hours_per_year &#x3D; null;
      case_data.replacement_cycle &#x3D; null;
    }
    return  case_data;
  }
  

}
</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'DialogData.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
